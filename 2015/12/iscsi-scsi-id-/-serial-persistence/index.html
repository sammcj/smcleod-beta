<!doctype html><html lang=en-au><head><meta name=viewport content="width=device-width"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=7"><link rel=icon href=../../../../favicon.png><link rel="shortcut icon" href=../../../../favicon.ico type=image/x-icon><link rel=apple-touch-icon href=../../../../apple-touch-icon.png><link rel=icon href=../../../../logo.svg type=image/svg+xml><title>iSCSI SCSI-ID / Serial Persistence &ndash;
smcleod.net</title><link href=../../../../symbols-nerd-font/symbols-nerd-font.css rel=stylesheet><link href=../../../../jetbrains-mono/jetbrains-mono.css rel=stylesheet><link type=text/css rel=stylesheet href=https://smcleod.net/css/styles.66349763506489d57ba916836ca1c45e0ac3f667fe4f2a152cf7619a81ad51a060782c6231e1a885e311c2fd9fdc72e95b340fbd9530152e367d478fe56978c5.css integrity="sha512-ZjSXY1BkidV7qRaDbKHEXgrD9mf+TyoVLPdhmoGtUaBgeCxiMeGoheMRwv2f3HLpWzQPvZUwFS42fUeP5Wl4xQ=="><link href=../../../../atkinson-hyperlegible/atkinson-hyperlegible.css rel=stylesheet><meta name=author content="Sam McLeod"><meta name=keywords content="storage,tech"><meta name=description content="o;Having a SCSI ID is a f*cking idiotic thing to do.&amp;rdquo;</strong></em></p>
<p><a href=&#34;http://yarchive.net/comp/linux/scsi_ids.html&#34;>- Linus Torvalds</a></p>
<p><em>&amp;hellip;and after the amount of time I&amp;rsquo;ve wasted getting XenServer to play nicely with LIO iSCSI failover I tend to agree.</em></p>
<hr>
<h2 id=&#34;the-problem&#34;>The Problem</h2>
<p>![]({{ site.url }}/img/san/sr_fail.jpg)</p>
<p>One oddity of Xen / XenServer&amp;rsquo;s storage subsystem is that it identifies iSCSI storage repositories via a calculated SCSI ID rather than the iSCSI Serial - which would be the sane thing to do.</p>
<p>Citrix&amp;rsquo;s less than ideal take on dealing with SCSI ID changes is for you to take your VMs offline, disconnected the storage repositories, recreate them, then go through all your VMs and re-attach their orphaned disks hoping that you remembered to add some sort of hint as to what VM they belong to, then finally wipe the sweat and tears from your face.</p>
<p>From <a href=&#34;https://support.citrix.com/article/CTX118641&#34;>CTX11641</a> - &amp;lsquo;How to Identify If SCSI Storage Repository has Changed SCSI IDs&amp;rsquo;:</p>
<blockquote>
<p>&amp;ldquo;The SCSI ID of the logical unit number (LUN) changed. When this happened, the iSCSI storage repository became unplugged after a XenServer reboot.&amp;rdquo;
&amp;hellip;
&amp;ldquo;To correct the issue you must recreate a PBD with the entry to reflect the right SCSI ID.&amp;rdquo;</p>
</blockquote>"><meta property="og:site_name" content="smcleod.net"><meta property="og:title" content="iSCSI SCSI-ID / Serial Persistence"><meta property="og:type" content="article"><meta property="article:author" content="Sam McLeod"><meta property="article:published_time" content="2015-12-14T00:00:00Z+0000"><meta property="article:tag" content="storage"><meta property="article:tag" content="tech"><meta property="og:url" content="https://smcleod.net/2015/12/iscsi-scsi-id-/-serial-persistence/"><meta property="og:image" content="https://smcleod.net/2015/12/iscsi-scsi-id-/-serial-persistence//feature-san-fran.jpg"><meta property="og:description" content="<p><em><strong>&amp;ldquo;Having a SCSI ID is a f*cking idiotic thing to do.&amp;rdquo;</strong></em></p>
<p><a href=&#34;http://yarchive.net/comp/linux/scsi_ids.html&#34;>- Li"><meta name=twitter:card content="summary_large_image"><meta property="twitter:domain" content="mcleod.ne"><meta property="twitter:url" content="https://smcleod.net/2015/12/iscsi-scsi-id-/-serial-persistence/"><meta name=twitter:title content="iSCSI SCSI-ID / Serial Persistence"><meta name=twitter:image content="https://smcleod.net/2015/12/iscsi-scsi-id-/-serial-persistence//feature-san-fran.jpg"><meta name=twitter:description content="<p><em><strong>&amp;ldquo;Having a SCSI ID is a f*cking idiotic thing to do.&amp;rdquo;</strong></em></p>
<p><a href=&#34;http://yarchive.net/comp/linux/scsi_ids.html&#34;>- Li"><link rel=manifest href=../../../../manifest/index.json></head><body><div id=baseContainer><header><div class=titleAndSearchContainer><div id=titleContainer><a class=unstyledLink href=../../../../><img src=../../../../logo.svg alt=Logo></a><div class=rightOfLogo><div class=titleAndHamburger><h1><a class=unstyledLink href=../../../../>smcleod.net</a></h1></div><div id=wide_nav><nav><ul id=main-nav><li><a href=../../../../>Home</a></li><li><a href=../../../../posts>Posts</a></li><li><a href=https://smcleod.net/pages/about/>About</a></li><li><a href=https://smcleod.net/pages/links/>Links</a></li><li><a href=../../../../tags>Tags</a></li></ul></nav></div></div></div><div class=search><input id=searchbar type=text placeholder=Search>
<a class=nerdlink onclick=newSearch()>&#xf002;</a></div><script>function newSearch(){let e=searchbar.value.trim();if(!e)return;location.href=`/search?q=${e}`}searchbar.onkeyup=e=>{e.keyCode==13&&newSearch()}</script></div><div id=links><a rel=noreferrer target=_blank class=nerdlink href=../../../../index.xml>&#xf09e;
<span>RSS</span></a>
<a rel=noreferrer target=_blank class=nerdlink href=https://github.com/sammcj>&#xf09b;
<span>Github</span></a>
<a rel=noreferrer target=_blank class=nerdlink href=https://twitter.com/s_mcleod>&#xf099;
<span>Twitter</span></a>
<a rel=noreferrer target=_blank class=nerdlink href=https://linkedin.com/in/sammcj>&#xf0e1;
<span>LinkedIn</span></a></div></header><div id=contentContainer><div id=content><main><article class="card single"><h1>iSCSI SCSI-ID / Serial Persistence</h1><p class=date><span title=Date></span>
2015-12-14</p><figure style=margin:0><img src=https://smcleod.net/2015/12/iscsi-scsi-id-/-serial-persistence//feature-san-fran.jpg alt></figure><div><p><em><strong>&ldquo;Having a SCSI ID is a f*cking idiotic thing to do.&rdquo;</strong></em></p><p><a href=http://yarchive.net/comp/linux/scsi_ids.html>- Linus Torvalds</a></p><p><em>&mldr;and after the amount of time I&rsquo;ve wasted getting XenServer to play nicely with LIO iSCSI failover I tend to agree.</em></p><hr><h2 id=the-problem>The Problem</h2><p>![]({{ site.url }}/img/san/sr_fail.jpg)</p><p>One oddity of Xen / XenServer&rsquo;s storage subsystem is that it identifies iSCSI storage repositories via a calculated SCSI ID rather than the iSCSI Serial - which would be the sane thing to do.</p><p>Citrix&rsquo;s less than ideal take on dealing with SCSI ID changes is for you to take your VMs offline, disconnected the storage repositories, recreate them, then go through all your VMs and re-attach their orphaned disks hoping that you remembered to add some sort of hint as to what VM they belong to, then finally wipe the sweat and tears from your face.</p><p>From <a href=https://support.citrix.com/article/CTX118641>CTX11641</a> - &lsquo;How to Identify If SCSI Storage Repository has Changed SCSI IDs&rsquo;:</p><blockquote><p>&ldquo;The SCSI ID of the logical unit number (LUN) changed. When this happened, the iSCSI storage repository became unplugged after a XenServer reboot.&rdquo;
&mldr;
&ldquo;To correct the issue you must recreate a PBD with the entry to reflect the right SCSI ID.&rdquo;</p></blockquote><h2 id=the-solution>The Solution</h2><p>A big thank you to Nicholas A. Bellinger from the Kernel SCSI mailing list who helped me a lot in <a href=http://comments.gmane.org/gmane.linux.scsi.target.devel/10617>this thread</a> where he explained:</p><blockquote><p>&ldquo;The Company ID, VSI, and VSIE are generated by LIO based upon the current <code>vpd_unit_serial</code> configfs attribute value. So as long as <code>vpd_unit_serial</code> is persistent, and the same value for backend devices across export failover to different nodes, Xen will always see the same EVPD information.&rdquo;</p><p>An example SCSI ID of <code>0x6001405bff3f42a49d84cfcb64e2b933</code> would thus be comprised of:</p><ul><li>NAA 6, IEEE Company_id: <code>0x1405</code></li><li>Vendor Specific Identifier: <code>0xbff3f42a4</code></li><li>Vendor Specific Identifier Extension: <code>0x9d84cfcb64e2b933</code></li></ul></blockquote><p>In addition to the <code>vpd_unit_serial</code> we found that the <code>iblock</code> number must also remain the same between failovers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>/sys/kernel/config/target/core/iblock_0/lun_name/wwn/vpd_unit_serial
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>/sys/kernel/config/target/core # tree
</span></span><span style=display:flex><span>├── iblock_0                            # Must be consistent between failovers
</span></span><span style=display:flex><span>│   └── iscsi_lun_r2
</span></span><span style=display:flex><span>│      └── wwn
</span></span><span style=display:flex><span>│         └── vpd_unit_serial           # Must be consistent between failovers
</span></span></code></pre></div><p>If you&rsquo;re using Corosync / Pacemaker for your target failover the <code>vpd_unit_serial</code> and <code>iblock</code> number must both be set in the <code>iSCSILogicalUnit</code> OCF provider:</p><ul><li>The <code>iblock</code> number is configured with <code>lio_iblock=&lt;number></code> - <a href=https://github.com/ClusterLabs/resource-agents/blob/master/heartbeat/iSCSILogicalUnit#L217>See iSCSILogicalUnit#L217</a></li><li>The <code>vpd_unit_serial</code> is configured with <code>scsi_sn=&lt;number></code> - <a href=https://github.com/ClusterLabs/resource-agents/blob/master/heartbeat/iSCSILogicalUnit#L138>See iSCSILogicalUnit#L138</a></li></ul><p>Here is an example of a target and lun configured with <code>pcs</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>Resource: iscsi_target_r2 (class=ocf provider=heartbeat type=iSCSITarget)
</span></span><span style=display:flex><span>Attributes: iqn=iqn.2003-01.org.linux-iscsi.pm-san.x8664:sn.ca7d7b33c731 portals=10.50.42.75:3260 implementation=lio-t additional_parameters=&#34;MaxConnections=100 AuthMethod=None InitialR2T=No MaxOutstandingR2T=64&#34;
</span></span><span style=display:flex><span>Operations: monitor on-fail=restart interval=30s timeout=20s (iscsi_target_r2-monitor-30s)
</span></span><span style=display:flex><span>            start on-fail=restart interval=0 timeout=20s (iscsi_target_r2-start-0)
</span></span><span style=display:flex><span>            stop on-fail=restart interval=0 timeout=20s (iscsi_target_r2-stop-0)
</span></span><span style=display:flex><span>Resource: iscsi_lun_r2 (class=ocf provider=heartbeat type=iSCSILogicalUnit)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Attributes: target_iqn=iqn.2003-01.org.linux-iscsi.pm-san.x8664:sn.ca7d7b33c731 scsi_sn=633c5643 lun=1 lio_iblock=2 path=/dev/drbd2 allowed_initiators=&#34;iqn.2015-05.com.example:51e1fb93&#34; implementation=lio-t
</span></span><span style=display:flex><span>Operations: monitor on-fail=restart interval=30s timeout=10s (iscsi_lun_r2-monitor-30s)
</span></span><span style=display:flex><span>            start on-fail=restart interval=0 timeout=20s (iscsi_lun_r2-start-0)
</span></span><span style=display:flex><span>            stop on-fail=restart interval=0 timeout=20s (iscsi_lun_r2-stop-0)
</span></span><span style=display:flex><span>Resource: iscsi_conf_r2 (class=ocf provider=heartbeat type=anything)
</span></span><span style=display:flex><span>Attributes: binfile=/usr/sbin/iscsi_iscsi_conf_r2.sh stop_timeout=3
</span></span></code></pre></div><p>If you happen to be using Puppet for your Pacemaker configuration it might look a bit like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>  cs_primitive { &#34;$iscsi_target_primitive&#34;:
</span></span><span style=display:flex><span>    primitive_class =&gt; &#39;ocf&#39;,
</span></span><span style=display:flex><span>    primitive_type  =&gt; &#39;iSCSITarget&#39;,
</span></span><span style=display:flex><span>    provided_by     =&gt; &#39;heartbeat&#39;,
</span></span><span style=display:flex><span>    parameters      =&gt; {  &#39;iqn&#39;                   =&gt; &#34;$iscsi_iqn&#34;,
</span></span><span style=display:flex><span>                          &#39;portals&#39;               =&gt; &#34;${iscsi_vip}:3260&#34;,
</span></span><span style=display:flex><span>                          &#39;implementation&#39;        =&gt; &#39;lio-t&#39;,
</span></span><span style=display:flex><span>                          &#39;additional_parameters&#39; =&gt; &#39;MaxConnections=100 AuthMethod=None InitialR2T=No MaxOutstandingR2T=64&#39;,
</span></span><span style=display:flex><span>                        },
</span></span><span style=display:flex><span>    operations      =&gt;  {  &#39;monitor&#39;              =&gt; { &#39;timeout&#39; =&gt; &#39;20s&#39;, &#39;interval&#39; =&gt; &#39;30s&#39;,&#39;on-fail&#39; =&gt; &#34;restart&#34;},
</span></span><span style=display:flex><span>                           &#39;start&#39;                =&gt; { &#39;timeout&#39; =&gt; &#39;20s&#39;, &#39;interval&#39; =&gt; &#39;0&#39;,&#39;on-fail&#39;   =&gt; &#34;restart&#34;},
</span></span><span style=display:flex><span>                           &#39;stop&#39;                 =&gt; { &#39;timeout&#39; =&gt; &#39;20s&#39;, &#39;interval&#39; =&gt; &#39;0&#39;,&#39;on-fail&#39;   =&gt; &#34;restart&#34;},
</span></span><span style=display:flex><span>                        },
</span></span><span style=display:flex><span>    require         =&gt; [Cs_primitive[&#34;$ip_primitive&#34;],Package[&#39;targetcli&#39;],Service[&#39;pacemaker&#39;]],
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cs_primitive { &#34;$iscsi_lun_primitive&#34;:
</span></span><span style=display:flex><span>    primitive_class =&gt; &#39;ocf&#39;,
</span></span><span style=display:flex><span>    primitive_type  =&gt; &#39;iSCSILogicalUnit&#39;,
</span></span><span style=display:flex><span>    provided_by     =&gt; &#39;heartbeat&#39;,
</span></span><span style=display:flex><span>    parameters      =&gt; {  &#39;target_iqn&#39;            =&gt; $iscsi_iqn,
</span></span><span style=display:flex><span>                          &#39;scsi_sn&#39;               =&gt; $scsi_sn,
</span></span><span style=display:flex><span>                          &#39;lun&#39;                   =&gt; &#39;1&#39;,
</span></span><span style=display:flex><span>                          &#39;lio_iblock&#39;            =&gt; $lio_iblock,
</span></span><span style=display:flex><span>                          &#39;path&#39;                  =&gt; $drbd_path,
</span></span><span style=display:flex><span>                          &#39;allowed_initiators&#39;    =&gt; $allowed_initiators,
</span></span><span style=display:flex><span>                          &#39;implementation&#39;        =&gt; &#39;lio-t&#39;},
</span></span><span style=display:flex><span>    operations      =&gt; {  &#39;monitor&#39;               =&gt; { &#39;timeout&#39; =&gt; &#39;10s&#39;, &#39;interval&#39; =&gt; &#39;30s&#39;,&#39;on-fail&#39; =&gt; &#34;restart&#34; },
</span></span><span style=display:flex><span>                          &#39;start&#39;                 =&gt; { &#39;timeout&#39; =&gt; &#39;20s&#39;, &#39;interval&#39; =&gt; &#39;0&#39;  ,&#39;on-fail&#39; =&gt; &#34;restart&#34; },
</span></span><span style=display:flex><span>                          &#39;stop&#39;                  =&gt; { &#39;timeout&#39; =&gt; &#39;20s&#39;, &#39;interval&#39; =&gt; &#39;0&#39;  ,&#39;on-fail&#39; =&gt; &#34;restart&#34; },
</span></span><span style=display:flex><span>                        },
</span></span><span style=display:flex><span>    require         =&gt; [Cs_primitive[&#34;$iscsi_target_primitive&#34;],Service[&#39;pacemaker&#39;]],
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div></div></article><hr><p class=articleTagsContainer><span></span>
<strong>Tags:</strong>
<a class=buttonTag href=../../../../tags/storage>#storage</a>
<a class=buttonTag href=../../../../tags/tech>#tech</a></p><div class=relatedArticlesContainer><hr><h2>More posts like this</h2><div class=postlist><article class="card postlistitem"><div><h2><a href=https://smcleod.net/2022/10/making-work-visible-avoid-dms/>Making Work Visible - Avoid DMs</a></h2><p class=date><span title=Date></span>
2022-10-20
|
<span title=Tags></span>
<a href=../../../../tags/communication>#communication</a>
<a href=../../../../tags/culture>#culture</a>
<a href=../../../../tags/tech>#tech</a>
<a href=../../../../tags/work>#work</a></p><a class=unstyledLink href=https://smcleod.net/2022/10/making-work-visible-avoid-dms/><img src=https://smcleod.net/2022/10/making-work-visible-avoid-dms//dm-disruption.jpg alt></a><div class=articlePreview><p><h3 id=avoid-sending-dmspms-for-support-and-technical-questions>Avoid sending DMs/PMs for support and technical questions</h3><p>This is a blurb I usually add to the wiki pages of teams I work with, it&rsquo;s a simple reminder that we should avoid sending direct messages (or worse - calling) individuals for support and technical questions.</p><p>Instead, we should use the appropriate channels for the team. This is a simple way to make work visible, share knowledge, reduce context switching, avoid silos and share the support load.</p></p><p><a href=https://smcleod.net/2022/10/making-work-visible-avoid-dms/>Continue reading </a></p></div></div><hr></article><article class="card postlistitem"><div><h2><a href=https://smcleod.net/2019/08/camels-dressed-as-unicorns/>Camels Dressed As Unicorns</a></h2><p class=date><span title=Date></span>
2019-08-08
|
<span title=Tags></span>
<a href=../../../../tags/career>#career</a>
<a href=../../../../tags/devops>#devops</a>
<a href=../../../../tags/tech>#tech</a></p><a class=unstyledLink href=https://smcleod.net/2019/08/camels-dressed-as-unicorns/><img src=https://smcleod.net/2019/08/camels-dressed-as-unicorns//camel_corn.jpeg alt></a><div class=articlePreview><p><h2 id=stop-trying-to-hire-with-titles-like-devops-engineer-or-cloud-engineer>Stop trying to hire with titles like ‘DevOps Engineer&rsquo; or &lsquo;Cloud Engineer&rsquo;</h2><p>&ldquo;DevOps is &mldr; not a job title&rdquo;</p><p>&ldquo;It&rsquo;s more of a cultural practice, like innovation, and it makes just as little sense hiring &ldquo;innovation engineers&rdquo; and expecting your organisation to be innovative, without also creating the culture to foster innovation.&rdquo; (Joel Shea when responding to this posted on <a href=https://www.linkedin.com/posts/activity-6564991913110368256-WxFP>LinkedIn</a>)</p><p>In most cases it&rsquo;s clear the organisation doesn&rsquo;t truly know what they want or need and likely don&rsquo;t understand the nuances of the aspects of engineering.</p><p>The problem is - they&rsquo;re going to end up with a ‘Camel Dressed As A Unicorn&rsquo; rather than someone with deep or natural engineering understanding in the areas they most need to help see, discuss, solve problems and deliver effective and lasting solutions.</p><p>From the what I&rsquo;ve seen recently companies hiring with &lsquo;DevOps Engineer&rsquo; titles - the organisation (thinks they) want / need a Developer with a little bit of Operations experience - but not a true understanding of Operations or platform engineering.</p><p>I&rsquo;m almost certain they&rsquo;re trying to appeal to the hype (in a genuine effort to find someone highly skilled) but as they&rsquo;re missing the point of where people&rsquo;s skills lay and what those skills mean - they&rsquo;re confusing engineers, recruiters and likely themselves further.</p><h2 id=devops-is-_deeply_-important>DevOps is <em>deeply</em> important</h2><p>Likely the most important thing to succeed at product and systems delivery - but it&rsquo;s not a job title.</p><p>If you need Developers to work in a DevOps culture and environment - say so.</p><p>If you need Operations or Platform Engineers to work in a DevOps culture and environment - say so.</p><p>Staying either of those does not mutually exclude ones abilities to know &lsquo;a bit of the other side&rsquo;, e.g. a Developer that has worked closely with a CI/CD system&rsquo;s backend or Kubernetes Operations, or an Operations Engineer that has worked closely with Developers and Testers and can work with APIs: or whip up some integration scripts when needed.</p></p><p><a href=https://smcleod.net/2019/08/camels-dressed-as-unicorns/>Continue reading </a></p></div></div><hr></article></div></div></main><footer><hr><div class=footerColumns><ul class=notlist><li><strong>Links</strong></li><li><a target=_blank href=https://github.com/sammcj>Github | @sammcj</a></li><li><a target=_blank href=https://twitter.com/s_mcleod>Twitter | @s_mcleod</a></li><li><a target=_blank href=https://smcleod.net>This Website | smcleod.net</a></li></ul></div><p><small>2022 &copy; Sam McLeod</small></p><p><small></small></p></footer></div></div></div></body></html>